<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A Creative Corner for New Ideas and Innovations"><meta name=author content="Dumindu Madunuwan"><meta name=theme-color content="#ffffff" media="(prefers-color-scheme: light)"><meta name=theme-color content="#101010" media="(prefers-color-scheme: dark)"><title>Concurrency Patterns in Golang ¬∑ Nu_1</title><link rel=canonical href=https://dumindu.github.io/nu_1/blog/concurrency-patterns-in-golang/><link rel=stylesheet href=/nu_1/assets/css/post.min.a0297b5a22a8a3d3bc4642d9077fe88070d72620bfe32eb1ddc9e4e07627e27b.css integrity><link rel=manifest href=/nu_1/manifest.json><link rel=icon href=/nu_1/favicon/favicon.ico><link rel=icon href=/nu_1/favicon/favicon-16x16.png sizes=16x16 type=image/png><link rel=icon href=/nu_1/favicon/favicon-32x32.png sizes=32x32 type=image/png><link rel=apple-touch-icon href=/nu_1/favicon/apple-touch-icon.png sizes=180x180></head><body><div id=outer-wrapper><div id=content-wrapper><header><a href=https://dumindu.github.io/nu_1/ class=site-logo>Nu_1</a></header><nav role=navigation><select onchange="this.value&&(window.location.href=this.value)"><button>
<selectedcontent></selectedcontent></button><option value=https://dumindu.github.io/nu_1/><span aria-hidden><i aria-hidden>üè° </i></span><span>Home</span></option><option value=https://dumindu.github.io/nu_1/blog/ selected><span aria-hidden><i aria-hidden>üßë‚Äçüíª </i></span><span>Blog</span></option><option value=https://dumindu.github.io/nu_1/welcome/><span aria-hidden><i aria-hidden>ü¶Ñ </i></span><span>Welcome</span></option></select></nav><main><article><img src=/nu_1/blog/concurrency-patterns-in-golang/cover.jpg srcset="/nu_1/blog/concurrency-patterns-in-golang/cover_hu_91c2af26fc412bd2.jpg 440w, /nu_1/blog/concurrency-patterns-in-golang/cover_hu_2996b8f2006a8688.jpg 1032w, /nu_1/blog/concurrency-patterns-in-golang/cover.jpg 5992w" sizes="(max-width: 440px) 440px, (max-width: 1032px) 1032px, 100vw" alt="Concurrency Patterns in Golang - cover image" style=view-transition-name:nu_1blogconcurrency-patterns-in-golangcoverjpg><header><h1 style=view-transition-name:nu_1blogconcurrency-patterns-in-golang>Concurrency Patterns in Golang</h1></header><div id=article-body><h2 id=essentials>Essentials</h2><h3 id=1-os-threads-vs-goroutines>1. OS Threads Vs Goroutines</h3><ul><li>OS Threads: Managed by the kernel, fixed stack size 1MB (But Modern Linux uses NPTL/ Native POSIX Thread Library, 256KB or less), context switching between OS threads requires a costly transition from user space to kernel space, forcing the operating system to interrupt its core work.</li><li>Goroutines: Managed by the Go runtime scheduler in user space, ~2KB dynamic stack size, can multiplex thousands of goroutines onto a very few OS threads, context switching is lightning-fast as it&rsquo;s managed in user space. Concurrently executing functions.</li></ul><h3 id=2-synchronization-patterns>2. Synchronization Patterns</h3><ul><li><p>General</p><ul><li><p>Locking</p><ul><li>Ensures mutual exclusion using primitives like Mutexes, RWMutexes, Semaphores, and critical sections. Only one thread accesses a critical section of shared data at a time. CPUs leverage sophisticated OS schedulers to put waiting threads to sleep and switch tasks efficiently.</li><li>Risk of deadlock and livelock; a thread holding a lock can be preempted by the OS scheduler, potentially blocking all other waiting threads for an unpredictable duration.</li></ul></li><li><p>Lock-Free</p><ul><li>Avoids blocking the entire system if one thread is delayed, using low-level hardware-intrinsic atomic operations like Compare-And-Swap (CAS) or Load-Link/Store-Conditional (LL/SC). Threads optimistically retry operations in a &ldquo;CAS loop&rdquo; if a conflict occurs.</li><li>Difficult to design and implement correctly; susceptible to issues like the ABA problem. Can perform worse than locks under heavy contention due to wasted work from retries; involves complex memory management strategies.</li></ul></li></ul></li><li><p>Go: Hybrid Approach</p><blockquote><p>Idiomatic Go emphasizes &ldquo;share memory by communicating&rdquo; via channels, using the CSP Communicating Sequential Processes) model to abstract away the complexity of low-level lock management from developers. Locking synchronization is managed entirely in user space to ensure channels are safe.</p></blockquote><ul><li><p>Lock-Based Primitives</p><ul><li>Mutexes & RWMutexes: Go provides the standard <code>sync.Mutex</code> (mutual exclusion) and <code>sync.RWMutex</code> (reader/writer lock) for protecting critical sections of complex data structures.</li><li>Channels (<code>chan</code>): The preferred idiomatic tool for concurrency management, often used to implement simple binary or counting semaphores via their buffer capacity.</li><li>Semaphores (<code>golang.org/x/sync/semaphore</code>): For formal, advanced use cases requiring features like context cancellation or weighted acquisition.</li><li>Wait Groups (<code>sync.WaitGroup</code>): Used when the main goroutine needs to block until a collection of other goroutines have all completed their tasks.</li><li>Condition Variables (<code>sync.Cond</code>): Used to coordinate goroutines that need to wait for a shared state to become true (Ex. a buffer going from empty to having items).</li><li>Once (<code>sync.Once</code>): Guarantees that a function is executed only once across the entire program runtime, typically used for lazy initialization (singletons).</li><li>Concurrent Map (<code>sync.Map</code>): A specialized map optimized for a cache-like access pattern (write once, read many times), offering better performance than a standard map with an RWMutex in specific scenarios.</li><li>Pool (<code>sync.Pool</code>): A mechanism to temporarily store and reuse allocated objects to reduce garbage collection overhead, managing access concurrently.</li><li>Error Group (<code>golang.org/x/sync/errgroup</code>): Simplifies running multiple goroutines that return errors. If any error occurs, the context is canceled, and the error is returned.</li><li>Single Flight (<code>golang.org/x/sync/singleflight</code>): Prevents duplicate function calls with the same key from running simultaneously; only one execution proceeds, and all callers receive that single result.</li></ul></li><li><p>Lock-Free Primitives (<code>sync/atomic</code>): This package offers functions like <code>AddInt64</code> and <code>CompareAndSwapInt64</code> for performing operations on basic types (<code>int32</code>, <code>int64</code>, <code>uint32</code>, <code>uint64</code>, <code>bool</code>, <code>pointer</code>). These high-throughput operations use direct CPU instructions and are advised only for special low-level needs due to their inherent implementation complexity.</p></li></ul></li></ul><hr><p>Let&rsquo;s look at some concurrency patterns in Go.</p><h2 id=fan-out--fan-in>Fan-Out / Fan-In</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>üí° Merger is optional, if all workers use the same channel                 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                       +--------------+                                   
</span></span><span class=line><span class=cl>            +--------&gt; |   WORKER 1   | --------+                         
</span></span><span class=line><span class=cl>            |          +--------------+         |                         
</span></span><span class=line><span class=cl>            |                                   |                         
</span></span><span class=line><span class=cl>            |          +--------------+         |                         
</span></span><span class=line><span class=cl>  input ----+--------&gt; |   WORKER 2   | --------+----&gt; merger ----&gt; output
</span></span><span class=line><span class=cl>            |          +--------------+         |                         
</span></span><span class=line><span class=cl>            |                                   |                         
</span></span><span class=line><span class=cl>            |          +--------------+         |                         
</span></span><span class=line><span class=cl>            +--------&gt; |   WORKER 3   | --------+                         
</span></span><span class=line><span class=cl>                       +--------------+                                   
</span></span><span class=line><span class=cl>                                                                          
</span></span><span class=line><span class=cl>            ‚Üë                                   ‚Üë                         
</span></span><span class=line><span class=cl>         Fan-Out                              Fan-In                       
</span></span></code></pre></div><p>Example: Pizza Delivery in a Restaurant,</p><ul><li>A single order taker (input channel) collects many pizza orders. Several cooks (multiple goroutines) grab orders and work on each parallelly. A single waiter (output channel) gathers every finished pizza and passes them to customers.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;math/rand&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;sync&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>const</span><span class=w> </span><span class=nx>minWait</span><span class=p>,</span><span class=w> </span><span class=nx>maxWait</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mf>0.1</span><span class=p>,</span><span class=w> </span><span class=mf>1.0</span><span class=w> </span><span class=c1>// Workers wait randomly 0.1 - 1 second</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>workerFunc</span><span class=p>(</span><span class=nx>input</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>output</span><span class=w> </span><span class=kd>chan</span><span class=o>&lt;-</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// Return as a func() to be called by wg.Go()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>input</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>randomNumber</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rand</span><span class=p>.</span><span class=nf>Float64</span><span class=p>()</span><span class=o>*</span><span class=p>(</span><span class=nx>maxWait</span><span class=o>-</span><span class=nx>minWait</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>minWait</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>randomNumber</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>output</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>input</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>output</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>wg</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Start workers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>workerCount</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>workerCount</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=nf>workerFunc</span><span class=p>(</span><span class=nx>input</span><span class=p>,</span><span class=w> </span><span class=nx>output</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Producer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nb>close</span><span class=p>(</span><span class=nx>input</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1-5 orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>input</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Close output when all workers are done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>close</span><span class=p>(</span><span class=nx>output</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Aggregator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>order</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>output</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Delivered order&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=pipelining-sequential-stage-pattern>Pipelining (Sequential Stage Pattern)</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>              +--------------+       +--------------+       +--------------+               
</span></span><span class=line><span class=cl>  input ----&gt; |   WORKER 1   | ----&gt; |   WORKER 2   | ----&gt; |   WORKER 3   | ----&gt; output  
</span></span><span class=line><span class=cl>              +--------------+       +--------------+       +--------------+               
</span></span><span class=line><span class=cl>                                                                                           
</span></span><span class=line><span class=cl>          ‚Üë                      ‚Üë                      ‚Üë                      ‚Üë           
</span></span><span class=line><span class=cl>    Stage 1 Chan           Stage 2 Chan           Stage 3 Chan           Stage 4 Chan      
</span></span></code></pre></div><p>Example: Assembly Line in a Car Factory,</p><ul><li>Unfinished cars move sequentially from one specialized stage to the next step-by-step (chassis -> add engine -> paint -> add tires -> safety test). All stages run concurrently, allowing work to pass immediately from one stage&rsquo;s output to the next stage&rsquo;s input.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>stage1</span><span class=p>(</span><span class=nx>in</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>out</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nb>close</span><span class=p>(</span><span class=nx>out</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>in</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>out</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=c1>// 1‚Äì5 -&gt; 2‚Äì10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>stage2</span><span class=p>(</span><span class=nx>in</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>out</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nb>close</span><span class=p>(</span><span class=nx>out</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>in</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>out</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=c1>// 2‚Äì10 -&gt; 10‚Äì50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Producer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>stage1Ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nb>close</span><span class=p>(</span><span class=nx>stage1Ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1-5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>stage1Ch</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>stage2Ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>stage1</span><span class=p>(</span><span class=nx>stage1Ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>stage3Ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>stage2</span><span class=p>(</span><span class=nx>stage2Ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>final</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>stage3Ch</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Final output&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>final</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=publishsubscribe-pubsub>Publish/Subscribe (Pub/Sub)</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>                                                          +----------------+                       
</span></span><span class=line><span class=cl>                                               +--------&gt; |  SUBSCRIBER 1  |   ‚Üê Chan 1/ Worker 1  
</span></span><span class=line><span class=cl>                                      TOPIC 1  |          +----------------+                       
</span></span><span class=line><span class=cl>                                     +---------|                                                   
</span></span><span class=line><span class=cl>                                     |         |          +----------------+                       
</span></span><span class=line><span class=cl>                                     |         +--------&gt; |  SUBSCRIBER 2  |   ‚Üê Chan 2/ Worker 2  
</span></span><span class=line><span class=cl>                +------------+       |                    +----------------+                       
</span></span><span class=line><span class=cl>  MESSAGE ----&gt; |   BROKER   | ----&gt; |                                                             
</span></span><span class=line><span class=cl>                +------------+       |                    +----------------+                       
</span></span><span class=line><span class=cl>                                     |         +--------&gt; |  SUBSCRIBER 3  |   ‚Üê Chan 3/ Worker 3  
</span></span><span class=line><span class=cl>                                     | TOPIC 2 |          +----------------+                       
</span></span><span class=line><span class=cl>                                     +---------|                                                   
</span></span><span class=line><span class=cl>                                               |          +----------------+                       
</span></span><span class=line><span class=cl>                                               +--------&gt; |  SUBSCRIBER 4  |   ‚Üê Chan 4/ Worker 4  
</span></span><span class=line><span class=cl>                                                          +----------------+                       
</span></span></code></pre></div><p>Example: Return Management in an Online Store,</p><ul><li>When a customer creates a return, the Return System publishes a single event like ‚ÄúReturnCreated‚Äù to the central event broker. Several services subscribe to this same event: Billing subscribes to decide if a refund is needed, Warehouse subscribes to expect the incoming package, Inventory subscribes to prepare to restock, and Notifications subscribes to email the customer. All these subscribers react in parallel to the same ‚ÄúReturnCreated‚Äù event, and the Return System doesn‚Äôt call any of them directly. It only publishes a message to the broker.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;sync&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Message</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Topic</span><span class=w>   </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Content</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>subscribeReq</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Topic</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Ch</span><span class=w>    </span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Broker implements the Active Object pattern using channels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Broker</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>subscribers</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Activation Queues for different types of requests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>publishCh</span><span class=w>   </span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>subscribeCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=nx>subscribeReq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>doneCh</span><span class=w>      </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>wg</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewBroker</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=nx>Broker</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>broker</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Broker</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>subscribers</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>publishCh</span><span class=p>:</span><span class=w>   </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>subscribeCh</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>subscribeReq</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>doneCh</span><span class=p>:</span><span class=w>      </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Active Object pattern: starts a single central goroutine to manage all internal state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>broker</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=nx>broker</span><span class=p>.</span><span class=nx>loop</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>broker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=o>*</span><span class=nx>Broker</span><span class=p>)</span><span class=w> </span><span class=nf>loop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=nx>msg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>b</span><span class=p>.</span><span class=nx>publishCh</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>subs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>append</span><span class=p>([]</span><span class=kd>chan</span><span class=w> </span><span class=nf>Message</span><span class=p>(</span><span class=kc>nil</span><span class=p>),</span><span class=w> </span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>[</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Topic</span><span class=p>]</span><span class=o>...</span><span class=p>)</span><span class=w> </span><span class=c1>// Copy on Read to operate outside the loop context safely</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>subs</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=nx>ch</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>msg</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Successfully sent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Subscriber is full/slow, drop message and continue to the next subscriber</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Warning: Dropping message for topic %s (consumer channel full/slow).\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>msg</span><span class=p>.</span><span class=nx>Topic</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribeCh</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Topic</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Topic</span><span class=p>],</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>Ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>b</span><span class=p>.</span><span class=nx>doneCh</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=nx>topic</span><span class=p>,</span><span class=w> </span><span class=nx>chans</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>chans</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nb>close</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>delete</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>,</span><span class=w> </span><span class=nx>topic</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=o>*</span><span class=nx>Broker</span><span class=p>)</span><span class=w> </span><span class=nf>Subscribe</span><span class=p>(</span><span class=nx>topic</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=c1>// Buffered</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>b</span><span class=p>.</span><span class=nx>subscribeCh</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>subscribeReq</span><span class=p>{</span><span class=nx>Topic</span><span class=p>:</span><span class=w> </span><span class=nx>topic</span><span class=p>,</span><span class=w> </span><span class=nx>Ch</span><span class=p>:</span><span class=w> </span><span class=nx>ch</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=o>*</span><span class=nx>Broker</span><span class=p>)</span><span class=w> </span><span class=nf>Publish</span><span class=p>(</span><span class=nx>msg</span><span class=w> </span><span class=nx>Message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>b</span><span class=p>.</span><span class=nx>publishCh</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>msg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=o>*</span><span class=nx>Broker</span><span class=p>)</span><span class=w> </span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>close</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>doneCh</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>b</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>warehouseFunc</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>input</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=p>)</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// Return as a func() to be called by wg.Go()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>input</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Informed to warehouse&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>Content</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>customerFunc</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>input</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=nx>Message</span><span class=p>)</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// Return as a func() to be called by wg.Go()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>input</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Informed to customer&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>Content</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>broker</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>NewBroker</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Subscribe to topics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>warehouseCh</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>broker</span><span class=p>.</span><span class=nf>Subscribe</span><span class=p>(</span><span class=s>&#34;return-created&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>customerCh</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>broker</span><span class=p>.</span><span class=nf>Subscribe</span><span class=p>(</span><span class=s>&#34;return-created&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>wg</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Subscriber workers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=nf>warehouseFunc</span><span class=p>(</span><span class=nx>warehouseCh</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=nf>customerFunc</span><span class=p>(</span><span class=nx>customerCh</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish a message</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>broker</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=nx>Message</span><span class=p>{</span><span class=nx>Topic</span><span class=p>:</span><span class=w> </span><span class=s>&#34;return-created&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>Content</span><span class=p>:</span><span class=w> </span><span class=s>`{&#34;orderID&#34;: &#34;1&#34;, &#34;itemID&#34;: &#34;1:1&#34;}`</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// In this example, we just wait 3 seconds to consume messages in the workers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Shut down broker: closes all subscriber channels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>broker</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer><time datetime=2025-11-26 title="Updated: 2025-12-11"><i>üïí</i> Created: 2025-11-26</time></footer></article></main><footer><div><i>üßë‚Äçüíª</i>Built by and copyright<a href=https://github.com/dumindu target=_blank>Dumindu Madunuwan</a><i>üìÖ</i> 2025<i>üöÄ</i> <a href=https://github.com/dumindu/nu_1 target=_blank>GitHub</a></div><div><button class=btn><i>‚òÄÔ∏è</i><i>‚ÅÑ</i><i>üåë</i></button></div></footer></div></div><script type=text/javascript src=/nu_1/assets/js/post.min.c8547379013b8a9d3b0bb417291ab4d778359264b06feb44401e3a1a40062184.js integrity></script></body></html>